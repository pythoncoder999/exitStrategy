<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Averaging Up Planner Â· Live Sync</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 10px; background: #f7f7f7; }
    h1 { text-align: center; color: #333; }
    .controls, .exit-plan, .plan { max-width: 600px; margin: 10px auto; background: white; padding: 15px; border-radius: 8px; }
    input, button, textarea { width: 100%; margin: 6px 0; padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
    .buy-step { border-bottom: 1px solid #eee; padding: 8px 0; display: flex; flex-direction: column; }
    .buy-step:last-child { border: none; }
    @media (min-width: 500px) {
      .buy-step { flex-direction: row; align-items: center; justify-content: space-between; }
      .buy-step > div { flex: 1; }
    }
  </style>
</head>
<body>

<h1>ðŸ“ˆ Live Averagingâ€‘Up Planner</h1>

<div class="controls">
  <input type="text" id="symbol" placeholder="Asset symbol (e.g. BTC, AAPL)" />
  <input type="number" id="capital" placeholder="Total Capital ($)" value="1000" />
  <input type="number" id="startPrice" placeholder="Start Price ($)" value="10" />
  <input type="number" id="percentStep" placeholder="% Increase / Buy" value="10" />
  <input type="number" id="stopLoss" placeholder="Stop Loss (%)" value="5" />
  <button onclick="generatePlan()">Generate Plan</button>
</div>

<div class="plan" id="buyPlan"></div>

<div class="exit-plan">
  <h3>Exit Strategy</h3>
  <input type="number" id="exitPrice" placeholder="Target Exit Price ($)" />
  <textarea id="exitNotes" placeholder="Exit conditions (momentum slowdown, etc.)"></textarea>
</div>

<div class="controls">
  <button onclick="downloadCSV()">ðŸ’¾ Save Plan CSV</button>
  <button onclick="loadCSV()">ðŸ“‚ Load Saved Plan</button>
  <button onclick="generatePDF()">ðŸ“„ Export PDF</button>
</div>

<script>
  let planData = [];
  let currentPrice = null;

  async function fetchPrice(sym) {
    try {
      const res = await fetch(`https://api.coingecko.com/api/v3/simple/price?ids=${sym.toLowerCase()}&vs_currencies=usd`);
      const json = await res.json();
      return json[sym.toLowerCase()]?.usd || null;
    } catch { return null; }
  }

  async function generatePlan() {
    const symbol = document.getElementById("symbol").value.trim();
    const capital = +document.getElementById("capital").value;
    const start = +document.getElementById("startPrice").value;
    const pct = +document.getElementById("percentStep").value;
    const sl = +document.getElementById("stopLoss").value;
    const stepCap = (capital / 5).toFixed(2);

    currentPrice = symbol ? await fetchPrice(symbol) : null;

    planData = [];
    const container = document.getElementById("buyPlan");
    container.innerHTML = `<p>Current Price of ${symbol.toUpperCase()}: ${
      currentPrice ? '$' + currentPrice : 'N/A'
    }</p>`;
    for (let i = 0; i < 5; i++) {
      const tp = +(start * Math.pow(1 + pct / 100, i)).toFixed(2);
      const sp = +(tp * (1 - sl / 100)).toFixed(2);
      planData.push({ step: i+1, targetPrice: tp, stopLoss: sp, capital: stepCap, checked: false });
      container.innerHTML += `
        <div class="buy-step">
          <div>
            <input type="checkbox" id="b${i}" onchange="toggleBuy(${i})">
            <label for="b${i}">Buy #${i+1}</label>
          </div>
          <div>Target: $${tp}</div>
          <div>Stopâ€‘Loss: $${sp}</div>
          <div>Capital: $${stepCap}</div>
        </div>`;
    }
  }

  function toggleBuy(i) { planData[i].checked = document.getElementById(`b${i}`).checked; }

  function downloadCSV() {
    const csv = Papa.unparse(planData);
    const blob = new Blob([csv], { type: 'text/csv' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = 'plan.csv';
    a.click();
  }

  function loadCSV() {
    const inp = document.createElement('input');
    inp.type = 'file'; inp.accept = '.csv';
    inp.onchange = e => {
      Papa.parse(e.target.files[0], {
        header: true,
        complete: r => {
          planData = r.data.map((r,i)=>({
            step: +r.step, targetPrice:+r.targetPrice,
            stopLoss:+r.stopLoss, capital:+r.capital,
            checked: r.checked === 'true'
          }));
          refresh();
        }
      });
    };
    inp.click();
  }

  function refresh() {
    generatePlan(); // regenerate UI, then restore checkboxes
    planData.forEach((p,i) => {
      document.getElementById(`b${i}`).checked = p.checked;
    });
  }

  function generatePDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(16);
    doc.text("Averagingâ€‘Up Plan", 10, 10);
    planData.forEach((p,i) => {
      doc.setFontSize(12);
      doc.text(`Buy #${p.step}: target $${p.targetPrice}, stop $${p.stopLoss}, cap $${p.capital}, done: ${p.checked}`, 10, 20 + i * 8);
    });
    const exitPrice = +document.getElementById("exitPrice").value;
    doc.text(`Exit Target: $${exitPrice}`, 10, 70);
    doc.text("Notes:", 10, 80);
    doc.setFontSize(10);
    doc.text(document.getElementById("exitNotes").value || '', 10, 90);
    doc.save("plan.pdf");
  }
</script>

</body>
</html>
