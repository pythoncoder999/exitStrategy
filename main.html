<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Calculator & Notes App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
            font-size: 2.5em;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .calculator-section {
            background: rgba(255, 255, 255, 0.9);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            transition: all 0.3s ease;
        }

        .calculator-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .calculator-title {
            text-align: center;
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .calculator-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .series-box {
            padding: 20px;
            border-radius: 12px;
            border: 2px solid;
        }

        .series-1 {
            background: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.3);
        }

        .series-2 {
            background: rgba(34, 197, 94, 0.1);
            border-color: rgba(34, 197, 94, 0.3);
        }

        .series-title {
            font-weight: 600;
            margin-bottom: 15px;
            font-size: 1.1em;
        }

        .result-box {
            background: linear-gradient(45deg, rgba(147, 51, 234, 0.1), rgba(219, 39, 119, 0.1));
            border: 2px solid rgba(147, 51, 234, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .warning-box {
            background: linear-gradient(45deg, rgba(255, 193, 7, 0.1), rgba(255, 152, 0, 0.1));
            border: 2px solid rgba(255, 193, 7, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
            color: #856404;
        }

        .error-box {
            background: linear-gradient(45deg, rgba(220, 53, 69, 0.1), rgba(244, 67, 54, 0.1));
            border: 2px solid rgba(220, 53, 69, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
            color: #721c24;
        }

        .weighted-avg-price {
            font-size: 2em;
            font-weight: bold;
            color: #8b5cf6;
            margin: 10px 0;
        }

        .transfer-section {
            text-align: center;
            margin: 20px 0;
        }

        .transfer-btn {
            background: linear-gradient(45deg, #8b5cf6, #ec4899);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .transfer-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(139, 92, 246, 0.4);
        }

        .transfer-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .calculation-details {
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
            font-size: 0.9em;
            text-align: left;
        }

        .formula {
            font-family: 'Courier New', monospace;
            background: rgba(0, 0, 0, 0.05);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }

        .volume-info {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        .notes-section {
            background: rgba(255, 255, 255, 0.8);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid rgba(102, 126, 234, 0.2);
            transition: all 0.3s ease;
        }

        .notes-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .notes-title {
            text-align: center;
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .input-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            color: #555;
            margin-bottom: 5px;
            font-size: 14px;
        }

        input[type="text"], input[type="number"], select {
            padding: 12px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        input[type="text"]:focus, input[type="number"]:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: scale(1.02);
        }

        .calculator-input {
            font-family: 'Courier New', monospace;
        }

        .error-input {
            border-color: #dc3545 !important;
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1) !important;
        }

        .target-input, .percentage-input {
            background: linear-gradient(45deg, #f8f9fa, #e9ecef);
            font-weight: 600;
        }

        .margin-select {
            background: linear-gradient(45deg, #fff3cd, #ffeaa7);
            font-weight: 600;
        }

        .investment-input {
            background: linear-gradient(45deg, #d1ecf1, #bee5eb);
            font-weight: 600;
        }

        .dropdown-container {
            position: relative;
        }

        .add-new-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            margin-top: 5px;
            width: 100%;
        }

        .add-new-btn:hover {
            background: #218838;
        }

        .manage-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            margin-top: 5px;
            width: 100%;
        }

        .manage-btn:hover {
            background: #545b62;
        }

        .dropdown-manager {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            max-height: 200px;
            overflow-y: auto;
        }

        .dropdown-manager h4 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #495057;
        }

        .dropdown-items {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .simple-dropdown-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            margin: 2px 0;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            font-size: 13px;
            transition: all 0.2s ease;
        }

        .simple-dropdown-item:hover {
            background: #f8f9fa;
            border-color: #dc3545;
        }

        .simple-remove-btn {
            background: none;
            border: none;
            color: #dc3545;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 3px;
            transition: all 0.2s ease;
        }

        .simple-remove-btn:hover {
            background: #dc3545;
            color: white;
            transform: scale(1.1);
        }

        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }

        button:hover::before {
            left: 100%;
        }

        .add-btn {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
        }

        .add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }

        .save-btn {
            background: linear-gradient(45deg, #2196F3, #1976D2);
            color: white;
        }

        .save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.4);
        }

        .upload-btn {
            background: linear-gradient(45deg, #FF9800, #F57C00);
            color: white;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 152, 0, 0.4);
        }

        .clear-btn {
            background: linear-gradient(45deg, #f44336, #d32f2f);
            color: white;
        }

        .clear-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(244, 67, 54, 0.4);
        }

        .plan-btn {
            background: linear-gradient(45deg, #17a2b8, #138496);
            color: white;
        }

        .plan-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(23, 162, 184, 0.4);
        }

        .controls-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 10px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .sort-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .sort-btn {
            padding: 8px 16px;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .sort-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
        }

        .sort-btn.active {
            background: linear-gradient(45deg, #28a745, #20c997);
        }

        .table-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            animation: fadeInUp 0.6s ease;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        td {
            padding: 12px 10px;
            border-bottom: 1px solid #e1e5e9;
            transition: background-color 0.3s ease;
        }

        tr:hover td {
            background-color: rgba(102, 126, 234, 0.05);
        }

        tr:nth-child(even) {
            background-color: rgba(248, 249, 250, 0.5);
        }

        .delete-btn {
            background: linear-gradient(45deg, #ff4757, #ff3838);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .delete-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 3px 10px rgba(255, 71, 87, 0.4);
        }

        .file-input {
            display: none;
        }

        .status-message {
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            font-weight: 600;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
        }

        .status-message.show {
            opacity: 1;
            transform: translateY(0);
        }

        .status-message.success {
            background: rgba(76, 175, 80, 0.1);
            color: #4CAF50;
            border: 2px solid rgba(76, 175, 80, 0.3);
        }

        .status-message.error {
            background: rgba(244, 67, 54, 0.1);
            color: #f44336;
            border: 2px solid rgba(244, 67, 54, 0.3);
        }

        .target-cell {
            font-weight: 600;
            color: #2196F3;
        }

        .margin-cell {
            font-weight: 600;
            color: #FF9800;
        }

        .available-cell {
            font-weight: 700;
            color: #28a745;
        }

        .up-percentage {
            color: #28a745;
            font-weight: 600;
        }

        .down-percentage {
            color: #dc3545;
            font-weight: 600;
        }

        /* Investment Planning Modal Styles */
        .investment-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            margin: 2% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 1000px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #667eea;
        }

        .modal-title {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8em;
            text-align: center;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .investment-summary {
            background: linear-gradient(45deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border: 2px solid rgba(102, 126, 234, 0.2);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            text-align: center;
        }

        .modal-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 25px;
            margin-bottom: 20px;
        }

        .investment-plan-section {
            background: rgba(23, 162, 184, 0.1);
            border: 2px solid rgba(23, 162, 184, 0.2);
            border-radius: 15px;
            padding: 20px;
        }

        .exit-plan-section {
            background: rgba(220, 53, 69, 0.1);
            border: 2px solid rgba(220, 53, 69, 0.2);
            border-radius: 15px;
            padding: 20px;
        }

        .section-title {
            text-align: center;
            margin-bottom: 15px;
            font-size: 1.2em;
            font-weight: 600;
        }

        .investment-table {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .investment-table th {
            background: linear-gradient(45deg, #17a2b8, #138496);
            color: white;
            padding: 15px;
            text-align: center;
        }

        .exit-table th {
            background: linear-gradient(45deg, #dc3545, #c82333);
            color: white;
            padding: 15px;
            text-align: center;
        }

        .investment-table td {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid #e9ecef;
        }

        .investment-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }

        .checkbox-cell {
            width: 60px;
        }

        .checkbox-cell input[type="checkbox"] {
            transform: scale(1.3);
            cursor: pointer;
        }

        .price-level {
            font-weight: 600;
            color: #667eea;
        }

        .investment-amount {
            font-weight: 600;
            color: #28a745;
        }

        .exit-amount {
            font-weight: 600;
            color: #dc3545;
        }

        .investment-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .status-exited {
            background: #f8d7da;
            color: #721c24;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            margin: 15px 0;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #28a745, #20c997);
            transition: width 0.3s ease;
        }

        .exit-summary {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .remaining-position {
            background: rgba(40, 167, 69, 0.1);
            border: 2px solid rgba(40, 167, 69, 0.2);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            text-align: center;
        }

        .remaining-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #28a745;
            margin: 5px 0;
        }

        @media (max-width: 1200px) {
            .input-row {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            }

            .modal-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }

            .calculator-grid {
                grid-template-columns: 1fr;
            }

            .input-row {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }

            .controls-section {
                flex-direction: column;
                align-items: stretch;
            }

            .sort-controls {
                justify-content: center;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 8px 4px;
            }

            .modal-content {
                width: 95%;
                margin: 5% auto;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìà Stock Calculator & Notes</h1>
        
        <!-- Volume Weighted Average Calculator -->
        <div class="calculator-section">
            <h2 class="calculator-title">üíπ Enhanced Volume Weighted Average Calculator</h2>
            
            <div class="calculator-grid">
                <div class="series-box series-1">
                    <h3 class="series-title">Series 1</h3>
                    <div class="input-group">
                        <label>Price 1 ($)</label>
                        <input type="number" id="price1" class="calculator-input" placeholder="0.00" step="0.0001" oninput="calculateWeightedAverage()">
                    </div>
                    <div class="input-group">
                        <label>Volume 1 (units)</label>
                        <input type="number" id="volume1" class="calculator-input" placeholder="0" step="1" oninput="calculateWeightedAverage()">
                        <div class="volume-info">Positive for purchases, negative for sales</div>
                    </div>
                </div>

                <div class="series-box series-2">
                    <h3 class="series-title">Series 2</h3>
                    <div class="input-group">
                        <label>Price 2 ($)</label>
                        <input type="number" id="price2" class="calculator-input" placeholder="0.00" step="0.0001" oninput="calculateWeightedAverage()">
                    </div>
                    <div class="input-group">
                        <label>Volume 2 (units)</label>
                        <input type="number" id="volume2" class="calculator-input" placeholder="0" step="1" oninput="calculateWeightedAverage()">
                        <div class="volume-info">Positive for purchases, negative for sales</div>
                    </div>
                </div>
            </div>

            <div id="errorBox" class="error-box" style="display: none;"></div>
            <div id="warningBox" class="warning-box" style="display: none;"></div>

            <div class="result-box" id="resultBox" style="display: none;">
                <div style="font-size: 1.2em; margin-bottom: 10px;">Volume Weighted Average Price:</div>
                <div class="weighted-avg-price" id="weightedAverageResult">$0.0000</div>
                <div style="font-size: 0.9em; color: #666; margin-top: 10px;">
                    <div>Total Value: $<span id="totalValue">0</span></div>
                    <div>Net Volume: <span id="totalVolume">0</span> units</div>
                    <div>Net Position: <span id="netPosition"></span></div>
                </div>
                
                <div class="calculation-details" id="calculationDetails">
                    <div><strong>Calculation:</strong></div>
                    <div class="formula" id="formulaDisplay"></div>
                </div>
            </div>

            <div class="transfer-section">
                <button class="transfer-btn" onclick="transferToTarget()" id="transferBtn" disabled>
                    üì§ Transfer to Target Price
                </button>
            </div>
        </div>

        <!-- Stock Notes Section -->
        <div class="notes-section">
            <h2 class="notes-title">üìä Stock Notes</h2>
            
            <div class="input-row">
                <div class="input-group">
                    <label for="stockSelect">Stock:</label>
                    <div class="dropdown-container">
                        <select id="stockSelect" onchange="checkCustomStock()">
                            <option value="">Select stock...</option>
                            <option value="AAPL">AAPL</option>
                            <option value="GOOGL">GOOGL</option>
                            <option value="MSFT">MSFT</option>
                            <option value="AMZN">AMZN</option>
                            <option value="TSLA">TSLA</option>
                            <option value="CUSTOM">+ Add New Stock</option>
                        </select>
                        <input type="text" id="customStock" placeholder="Enter new stock..." style="display: none; margin-top: 5px;">
                        <button class="add-new-btn" id="addStockBtn" onclick="addNewStock()" style="display: none;">Add Stock</button>
                        <button class="manage-btn" onclick="toggleStockManager()">Manage Stocks</button>
                        <div id="stockManager" class="dropdown-manager" style="display: none;">
                            <h4>Click 'x' to remove stocks:</h4>
                            <div id="stockItems" class="dropdown-items"></div>
                        </div>
                    </div>
                </div>
                
                <div class="input-group">
                    <label for="currentInput">Current Price:</label>
                    <input type="number" id="currentInput" placeholder="0.00" step="0.01" oninput="calculatePercentageChange()" />
                </div>
                
                <div class="input-group">
                    <label for="targetInput">Target:</label>
                    <input type="number" id="targetInput" class="target-input" placeholder="Enter target price" oninput="calculatePercentageChange()" />
                </div>
                
                <div class="input-group">
                    <label for="marginSelect">Margin Ratio:</label>
                    <div class="dropdown-container">
                        <select id="marginSelect" class="margin-select" onchange="checkCustomMargin(); calculateAvailable()">
                            <option value="20">20%</option>
                            <option value="25">25%</option>
                            <option value="30">30%</option>
                            <option value="100">100%</option>
                            <option value="CUSTOM">+ Custom Ratio</option>
                        </select>
                        <input type="number" id="customMargin" placeholder="Enter custom ratio..." step="1" min="1" max="100" style="display: none; margin-top: 5px;">
                        <button class="add-new-btn" id="addMarginBtn" onclick="addCustomMargin()" style="display: none;">Add Ratio</button>
                        <button class="manage-btn" onclick="toggleMarginManager()">Manage Ratios</button>
                        <div id="marginManager" class="dropdown-manager" style="display: none;">
                            <h4>Click 'x' to remove ratios:</h4>
                            <div id="marginItems" class="dropdown-items"></div>
                        </div>
                    </div>
                </div>
                
                <div class="input-group">
                    <label for="averagingUpSelect">Averaging Up Rate (%):</label>
                    <div class="dropdown-container">
                        <select id="averagingUpSelect" class="margin-select" onchange="checkCustomAveragingUp()">
                            <option value="3">3%</option>
                            <option value="5">5%</option>
                            <option value="7">7%</option>
                            <option value="10">10%</option>
                            <option value="15">15%</option>
                            <option value="CUSTOM">+ Custom Rate</option>
                        </select>
                        <input type="number" id="customAveragingUp" placeholder="Enter custom rate..." step="0.1" min="0.1" max="50" style="display: none; margin-top: 5px;">
                        <button class="add-new-btn" id="addAveragingUpBtn" onclick="addCustomAveragingUp()" style="display: none;">Add Rate</button>
                        <button class="manage-btn" onclick="toggleAveragingUpManager()">Manage Rates</button>
                        <div id="averagingUpManager" class="dropdown-manager" style="display: none;">
                            <h4>Click 'x' to remove rates:</h4>
                            <div id="averagingUpItems" class="dropdown-items"></div>
                        </div>
                    </div>
                </div>
                
                <div class="input-group">
                    <label for="stopLossSelect">Stop Loss Rate (%):</label>
                    <div class="dropdown-container">
                        <select id="stopLossSelect" class="margin-select" onchange="checkCustomStopLoss()">
                            <option value="5">5%</option>
                            <option value="7">7%</option>
                            <option value="10">10%</option>
                            <option value="15">15%</option>
                            <option value="20">20%</option>
                            <option value="CUSTOM">+ Custom Rate</option>
                        </select>
                        <input type="number" id="customStopLoss" placeholder="Enter custom rate..." step="0.1" min="0.1" max="50" style="display: none; margin-top: 5px;">
                        <button class="add-new-btn" id="addStopLossBtn" onclick="addCustomStopLoss()" style="display: none;">Add Rate</button>
                        <button class="manage-btn" onclick="toggleStopLossManager()">Manage Rates</button>
                        <div id="stopLossManager" class="dropdown-manager" style="display: none;">
                            <h4>Click 'x' to remove rates:</h4>
                            <div id="stopLossItems" class="dropdown-items"></div>
                        </div>
                    </div>
                </div>
                
                <div class="input-group">
                    <label for="investmentInput">Investment Amount:</label>
                    <input type="text" id="investmentInput" class="investment-input" placeholder="0" oninput="calculateAvailable()" />
                </div>
                
                <div class="input-group">
                    <label for="percentageInput">Up/Down % (Auto):</label>
                    <input type="number" id="percentageInput" class="percentage-input" placeholder="Auto-calculated..." readonly />
                </div>
            </div>
            
            <div class="button-group">
                <button class="add-btn" onclick="addNote()">‚ûï Add Stock</button>
                <button class="save-btn" onclick="saveData()">üíæ Save Data</button>
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">üìÅ Upload Data</button>
                <button class="clear-btn" onclick="clearAll()">üóëÔ∏è Clear All</button>
            </div>
        </div>

        <input type="file" id="fileInput" class="file-input" accept=".json" onchange="uploadData(event)" />
        
        <div id="statusMessage" class="status-message"></div>

        <div class="controls-section">
            <div class="sort-controls">
                <span style="font-weight: 600; color: #555;">Sort by:</span>
                <button class="sort-btn" onclick="sortBy('stock')" id="sortStock">Stock ‚Üï</button>
                <button class="sort-btn" onclick="sortBy('percentage')" id="sortPercentage">% Change ‚Üï</button>
                <button class="sort-btn" onclick="sortBy('available')" id="sortAvailable">Available ‚Üï</button>
            </div>
            <div style="font-weight: 600; color: #555;">
                Total Records: <span id="totalCount">0</span>
            </div>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Date & Time</th>
                        <th>Stock</th>
                        <th>Current</th>
                        <th>Target</th>
                        <th>% Change</th>
                        <th>Margin</th>
                        <th>Available</th>
                        <th>Investment Plan</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="notesTable">
                    <!-- Records will be added here -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Investment Planning Modal -->
    <div id="investmentModal" class="investment-modal">
        <div class="modal-content">
            <span class="close" onclick="closeInvestmentModal()">&times;</span>
            <h2 class="modal-title">üìä Investment & Exit Planning</h2>
            
            <div class="investment-summary" id="investmentSummary">
                <!-- Summary will be populated here -->
            </div>
            
            <div class="modal-grid">
                <!-- Investment Plan Section -->
                <div class="investment-plan-section">
                    <h3 class="section-title" style="color: #17a2b8;">üìà Investment Plan</h3>
                    
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                    </div>
                    
                    <div class="investment-table">
                        <table>
                            <thead>
                                <tr>
                                    <th>‚úì</th>
                                    <th>Level</th>
                                    <th>Price Target</th>
                                    <th>Investment</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="investmentPlanTable">
                                <!-- Investment plan will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Exit Plan Section -->
                <div class="exit-plan-section">
                    <h3 class="section-title" style="color: #dc3545;">üéØ Exit Plan</h3>
                    
                    <div class="remaining-position" id="remainingPosition">
                        <div style="font-size: 14px; color: #666;">Current Position Value</div>
                        <div class="remaining-value" id="remainingValue">$0</div>
                        <div style="font-size: 12px; color: #666;">Available for Exit</div>
                    </div>
                    
                    <div class="exit-summary" id="exitSummaryContent">
                        <!-- Exit summary will be populated here -->
                    </div>
                    
                    <div class="investment-table exit-table">
                        <table style="font-size: 12px;">
                            <thead>
                                <tr>
                                    <th>‚úì</th>
                                    <th>Level</th>
                                    <th>Exit Price</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="exitPlanTable">
                                <!-- Exit plan will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let notes = [];
        let stockOptions = ['AAPL', 'GOOGL', 'MSFT', 'AMZN', 'TSLA'];
        let marginRatios = [20, 25, 30, 100];
        let averagingUpRates = [3, 5, 7, 10, 15];
        let stopLossRates = [5, 7, 10, 15, 20];
        let currentSort = null;
        let sortDirection = 'asc';
        let currentWeightedAverage = 0;
        let currentInvestmentPlan = null;

        // Enhanced Volume Weighted Average Calculator Functions
        function parseInputValue(value) {
            if (value === '' || value === null || value === undefined) {
                return 0;
            }
            const parsed = parseFloat(value);
            return isNaN(parsed) ? 0 : parsed;
        }

        function formatNumber(num, decimals = 4) {
            if (num === 0) return '0';
            if (Math.abs(num) >= 1000000) {
                return (num / 1000000).toFixed(2) + 'M';
            } else if (Math.abs(num) >= 1000) {
                return (num / 1000).toFixed(2) + 'K';
            }
            return num.toFixed(decimals);
        }

        function formatCurrency(num) {
            if (num === 0) return '$0';
            const absNum = Math.abs(num);
            let formatted;
            
            if (absNum >= 1000000) {
                formatted = (num / 1000000).toFixed(2) + 'M';
            } else if (absNum >= 1000) {
                formatted = (num / 1000).toFixed(2) + 'K';
            } else {
                formatted = num.toFixed(2);
            }
            
            return (num >= 0 ? ' : '-) + formatted.replace('-', '');
        }

        function showError(message) {
            const errorBox = document.getElementById('errorBox');
            errorBox.textContent = '‚ö†Ô∏è Error: ' + message;
            errorBox.style.display = 'block';
            
            setTimeout(() => {
                errorBox.style.display = 'none';
            }, 5000);
        }

        function showWarning(message) {
            const warningBox = document.getElementById('warningBox');
            warningBox.textContent = '‚ö†Ô∏è Warning: ' + message;
            warningBox.style.display = 'block';
            
            setTimeout(() => {
                warningBox.style.display = 'none';
            }, 5000);
        }

        function hideMessages() {
            document.getElementById('errorBox').style.display = 'none';
            document.getElementById('warningBox').style.display = 'none';
        }

        function clearInputErrors() {
            const inputs = document.querySelectorAll('.calculator-input');
            inputs.forEach(input => input.classList.remove('error-input'));
        }

        function markInputError(inputId) {
            document.getElementById(inputId).classList.add('error-input');
        }

        function validateInputs(p1, v1, p2, v2) {
            const errors = [];
            
            if (p1 < 0) {
                errors.push('Price 1 cannot be negative');
                markInputError('price1');
            }
            if (p2 < 0) {
                errors.push('Price 2 cannot be negative');
                markInputError('price2');
            }
            
            if (p1 === 0 && v1 !== 0) {
                errors.push('Price 1 cannot be zero when Volume 1 is non-zero');
                markInputError('price1');
            }
            if (p2 === 0 && v2 !== 0) {
                errors.push('Price 2 cannot be zero when Volume 2 is non-zero');
                markInputError('price2');
            }
            
            const maxValue = 1000000000;
            if (Math.abs(p1) > maxValue || Math.abs(p2) > maxValue || 
                Math.abs(v1) > maxValue || Math.abs(v2) > maxValue) {
                errors.push('Input values are too large');
            }
            
            return errors;
        }

        function calculateWeightedAverage() {
            try {
                clearInputErrors();
                hideMessages();
                
                const p1 = parseInputValue(document.getElementById('price1').value);
                const v1 = parseInputValue(document.getElementById('volume1').value);
                const p2 = parseInputValue(document.getElementById('price2').value);
                const v2 = parseInputValue(document.getElementById('volume2').value);

                const resultBox = document.getElementById('resultBox');
                const transferBtn = document.getElementById('transferBtn');

                const validationErrors = validateInputs(p1, v1, p2, v2);
                if (validationErrors.length > 0) {
                    showError(validationErrors.join('. '));
                    resultBox.style.display = 'none';
                    transferBtn.disabled = true;
                    currentWeightedAverage = 0;
                    return;
                }

                if (p1 === 0 && p2 === 0 && v1 === 0 && v2 === 0) {
                    resultBox.style.display = 'none';
                    transferBtn.disabled = true;
                    currentWeightedAverage = 0;
                    return;
                }

                const totalValue = (p1 * v1) + (p2 * v2);
                const totalVolume = v1 + v2;

                if (totalVolume === 0) {
                    if (totalValue !== 0) {
                        showError('Total volume is zero but total value is not zero. Cannot calculate weighted average.');
                        resultBox.style.display = 'none';
                        transferBtn.disabled = true;
                        currentWeightedAverage = 0;
                        return;
                    } else {
                        showWarning('Both volume and value are zero. No position exists.');
                        resultBox.style.display = 'none';
                        transferBtn.disabled = true;
                        currentWeightedAverage = 0;
                        return;
                    }
                }

                const weightedAverage = totalValue / totalVolume;

                if (!isFinite(weightedAverage) || isNaN(weightedAverage)) {
                    showError('Calculation resulted in an invalid number.');
                    resultBox.style.display = 'none';
                    transferBtn.disabled = true;
                    currentWeightedAverage = 0;
                    return;
                }

                if (weightedAverage < 0) {
                    showWarning('Calculated weighted average is negative. Please verify your inputs.');
                }

                currentWeightedAverage = weightedAverage;

                document.getElementById('weightedAverageResult').textContent = ' + formatNumber(weightedAverage, 4);
                document.getElementById('totalValue').textContent = formatCurrency(totalValue).replace(', '');
                document.getElementById('totalVolume').textContent = formatNumber(totalVolume, 0);

                const netPositionElement = document.getElementById('netPosition');
                if (totalVolume > 0) {
                    netPositionElement.textContent = 'Long Position';
                    netPositionElement.style.color = '#28a745';
                } else {
                    netPositionElement.textContent = 'Short Position';
                    netPositionElement.style.color = '#dc3545';
                }

                const formulaDisplay = document.getElementById('formulaDisplay');
                formulaDisplay.innerHTML = `
                    VWAP = (P‚ÇÅ √ó V‚ÇÅ + P‚ÇÇ √ó V‚ÇÇ) √∑ (V‚ÇÅ + V‚ÇÇ)<br>
                    VWAP = (${formatNumber(p1, 4)} √ó ${formatNumber(v1, 0)} + ${formatNumber(p2, 4)} √ó ${formatNumber(v2, 0)}) √∑ (${formatNumber(v1, 0)} + ${formatNumber(v2, 0)})<br>
                    VWAP = (${formatNumber(p1 * v1, 2)} + ${formatNumber(p2 * v2, 2)}) √∑ ${formatNumber(totalVolume, 0)}<br>
                    VWAP = ${formatNumber(totalValue, 2)} √∑ ${formatNumber(totalVolume, 0)}<br>
                    VWAP = ${formatNumber(weightedAverage, 4)}
                `;

                resultBox.style.display = 'block';
                transferBtn.disabled = false;

                if (Math.abs(totalVolume) < Math.abs(v1) * 0.1 || Math.abs(totalVolume) < Math.abs(v2) * 0.1) {
                    showWarning('Net volume is very small compared to individual volumes. Result may be sensitive to small changes.');
                }

            } catch (error) {
                console.error('Calculation error:', error);
                showError('An unexpected error occurred during calculation: ' + error.message);
                
                document.getElementById('resultBox').style.display = 'none';
                document.getElementById('transferBtn').disabled = true;
                currentWeightedAverage = 0;
            }
        }

        function transferToTarget() {
            if (currentWeightedAverage > 0) {
                document.getElementById('targetInput').value = currentWeightedAverage.toFixed(4);
                calculatePercentageChange();
                showStatus('Weighted average transferred to target price!', 'success');
                document.querySelector('.notes-section').scrollIntoView({ behavior: 'smooth' });
            }
        }

        // Original Utility Functions
        function getCurrentDateTime() {
            const now = new Date();
            return now.toLocaleString('en-US', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });
        }

        function formatInvestmentAmount(amount) {
            if (amount === 0) return '$0';
            return `${amount.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }

        function parseInvestmentInput(value) {
            return parseFloat(value.replace(/[$,\s]/g, '')) || 0;
        }

        function formatInvestmentInput(input) {
            let value = input.value.replace(/[$,\s]/g, '');
            let numValue = parseFloat(value) || 0;
            
            if (numValue > 0) {
                input.value = numValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }
        }

        function parseNumber(str) {
            if (!str) return 0;
            return parseFloat(str.replace(/,/g, '')) || 0;
        }

        function formatNumberWithCommas(num) {
            if (!num) return '';
            const cleanNum = num.toString().replace(/[^\d.]/g, '');
            const parts = cleanNum.split('.');
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            return parts.join('.');
        }

        function handleVolumeInput(input) {
            const value = input.value.replace(/[^\d]/g, '');
            input.value = value ? formatNumberWithCommas(value) : '';
        }

        // Stock Management Functions
        function checkCustomStock() {
            const select = document.getElementById('stockSelect');
            const customInput = document.getElementById('customStock');
            const addBtn = document.getElementById('addStockBtn');

            if (select.value === 'CUSTOM') {
                customInput.style.display = 'block';
                addBtn.style.display = 'block';
                customInput.focus();
            } else {
                customInput.style.display = 'none';
                addBtn.style.display = 'none';
            }
        }

        function addNewStock() {
            const customInput = document.getElementById('customStock');
            const select = document.getElementById('stockSelect');
            const newStock = customInput.value.trim().toUpperCase();

            if (newStock && !stockOptions.includes(newStock)) {
                stockOptions.push(newStock);
                stockOptions.sort();
                updateStockDropdown();
                select.value = newStock;
                customInput.style.display = 'none';
                document.getElementById('addStockBtn').style.display = 'none';
                customInput.value = '';
                updateStockManager();
                showStatus(`Stock "${newStock}" added successfully!`, 'success');
            } else if (stockOptions.includes(newStock)) {
                showStatus(`Stock "${newStock}" already exists!`, 'error');
            } else {
                showStatus('Please enter a valid stock symbol!', 'error');
            }
        }

        function toggleStockManager() {
            const manager = document.getElementById('stockManager');
            if (manager.style.display === 'none') {
                manager.style.display = 'block';
                updateStockManager();
            } else {
                manager.style.display = 'none';
            }
        }

        function updateStockManager() {
            const container = document.getElementById('stockItems');
            container.innerHTML = '';

            stockOptions.forEach(stock => {
                const item = document.createElement('div');
                item.className = 'simple-dropdown-item';
                item.innerHTML = `
                    <span>${stock}</span>
                    <button class="simple-remove-btn" onclick="removeStock('${stock}')" title="Remove ${stock}">√ó</button>
                `;
                container.appendChild(item);
            });
        }

        function removeStock(stockToRemove) {
            if (stockOptions.length <= 1) {
                showStatus('Cannot remove the last stock option!', 'error');
                return;
            }

            stockOptions = stockOptions.filter(stock => stock !== stockToRemove);
            updateStockDropdown();
            updateStockManager();
            
            const select = document.getElementById('stockSelect');
            if (select.value === stockToRemove) {
                select.value = '';
            }
            
            showStatus(`Stock "${stockToRemove}" removed!`, 'success');
        }

        function updateStockDropdown() {
            const select = document.getElementById('stockSelect');
            const customOption = select.querySelector('option[value="CUSTOM"]');
            const currentValue = select.value;
            
            const existingOptions = select.querySelectorAll('option:not([value=""]):not([value="CUSTOM"])');
            existingOptions.forEach(option => option.remove());
            
            stockOptions.forEach(stock => {
                const option = document.createElement('option');
                option.value = stock;
                option.textContent = stock;
                select.insertBefore(option, customOption);
            });

            if (stockOptions.includes(currentValue)) {
                select.value = currentValue;
            }
        }

        // Margin Management Functions
        function checkCustomMargin() {
            const select = document.getElementById('marginSelect');
            const customInput = document.getElementById('customMargin');
            const addBtn = document.getElementById('addMarginBtn');

            if (select.value === 'CUSTOM') {
                customInput.style.display = 'block';
                addBtn.style.display = 'block';
                customInput.focus();
            } else {
                customInput.style.display = 'none';
                addBtn.style.display = 'none';
            }
        }

        function addCustomMargin() {
            const customInput = document.getElementById('customMargin');
            const select = document.getElementById('marginSelect');
            const newMargin = parseInt(customInput.value);

            if (newMargin && newMargin > 0 && newMargin <= 100 && !marginRatios.includes(newMargin)) {
                marginRatios.push(newMargin);
                marginRatios.sort((a, b) => a - b);
                updateMarginDropdown();
                select.value = newMargin.toString();
                customInput.style.display = 'none';
                document.getElementById('addMarginBtn').style.display = 'none';
                customInput.value = '';
                updateMarginManager();
                calculateAvailable();
                showStatus(`Margin ratio "${newMargin}%" added successfully!`, 'success');
            } else if (marginRatios.includes(newMargin)) {
                showStatus(`Margin "${newMargin}%" already exists!`, 'error');
            } else {
                showStatus('Please enter a valid margin between 1% and 100%!', 'error');
            }
        }

        function toggleMarginManager() {
            const manager = document.getElementById('marginManager');
            if (manager.style.display === 'none') {
                manager.style.display = 'block';
                updateMarginManager();
            } else {
                manager.style.display = 'none';
            }
        }

        function updateMarginManager() {
            const container = document.getElementById('marginItems');
            container.innerHTML = '';

            marginRatios.forEach(margin => {
                const item = document.createElement('div');
                item.className = 'simple-dropdown-item';
                item.innerHTML = `
                    <span>${margin}%</span>
                    <button class="simple-remove-btn" onclick="removeMargin(${margin})" title="Remove ${margin}%">√ó</button>
                `;
                container.appendChild(item);
            });
        }

        function removeMargin(marginToRemove) {
            if (marginRatios.length <= 1) {
                showStatus('Cannot remove the last margin option!', 'error');
                return;
            }

            marginRatios = marginRatios.filter(m => m !== marginToRemove);
            updateMarginDropdown();
            updateMarginManager();
            
            const select = document.getElementById('marginSelect');
            if (select.value === marginToRemove.toString()) {
                select.value = marginRatios[0] ? marginRatios[0].toString() : '20';
                calculateAvailable();
            }
            
            showStatus(`Margin "${marginToRemove}%" removed!`, 'success');
        }

        function updateMarginDropdown() {
            const select = document.getElementById('marginSelect');
            const customOption = select.querySelector('option[value="CUSTOM"]');
            const currentValue = select.value;
            
            const existingOptions = select.querySelectorAll('option:not([value="CUSTOM"])');
            existingOptions.forEach(option => option.remove());
            
            marginRatios.forEach(margin => {
                const option = document.createElement('option');
                option.value = margin.toString();
                option.textContent = `${margin}%`;
                select.insertBefore(option, customOption);
            });

            if (marginRatios.includes(parseInt(currentValue))) {
                select.value = currentValue;
            }
        }

        // Averaging Up Management Functions
        function checkCustomAveragingUp() {
            const select = document.getElementById('averagingUpSelect');
            const customInput = document.getElementById('customAveragingUp');
            const addBtn = document.getElementById('addAveragingUpBtn');

            if (select.value === 'CUSTOM') {
                customInput.style.display = 'block';
                addBtn.style.display = 'block';
                customInput.focus();
            } else {
                customInput.style.display = 'none';
                addBtn.style.display = 'none';
            }
        }

        function addCustomAveragingUp() {
            const customInput = document.getElementById('customAveragingUp');
            const select = document.getElementById('averagingUpSelect');
            const newRate = parseFloat(customInput.value);

            if (newRate && newRate > 0 && newRate <= 50 && !averagingUpRates.includes(newRate)) {
                averagingUpRates.push(newRate);
                averagingUpRates.sort((a, b) => a - b);
                updateAveragingUpDropdown();
                select.value = newRate.toString();
                customInput.style.display = 'none';
                document.getElementById('addAveragingUpBtn').style.display = 'none';
                customInput.value = '';
                updateAveragingUpManager();
                showStatus(`Averaging up rate "${newRate}%" added successfully!`, 'success');
            } else if (averagingUpRates.includes(newRate)) {
                showStatus(`Rate "${newRate}%" already exists!`, 'error');
            } else {
                showStatus('Please enter a valid rate between 0.1% and 50%!', 'error');
            }
        }

        function toggleAveragingUpManager() {
            const
